<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Web Watcher</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans"; margin: 24px; }
    h1 { font-size: 22px; }
    form { display: grid; gap: 12px; max-width: 720px; }
    label { font-weight: 600; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; }
    .primary { background: black; color: white; }
    .card { border: 1px solid #eee; padding: 16px; border-radius: 14px; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: left; vertical-align: middle; }
    .row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .muted { color: #666; font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Drag styles */
    th.drag, td.drag { width: 32px; text-align: center; }
    .drag-handle { cursor: grab; user-select: none; font-size: 18px; line-height: 1; }
    tr.dragging { opacity: .5; }

    /* Toast */
    #toast { position: fixed; right: 16px; bottom: 16px; background: #111; color: #fff; padding: 10px 12px; border-radius: 10px; opacity: 0; transform: translateY(10px); transition: all .25s ease; }
    #toast.show { opacity: 1; transform: translateY(0); }

    /* Buttons */
    .run-now[disabled] { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>Web Watcher</h1>
  <p class="muted">
    Poll a webpage on an interval, take a screenshot, extract text (DOM → OCR fallback),
    and (optionally) ping a Discord webhook when your target text is found or a C$ price is ≤ your threshold.
    Drag the rows to reorder how jobs are listed.
  </p>

  <form method="post" action="/jobs">
    <div>
      <label>Website URL</label>
      <input type="url" name="url" placeholder="https://example.com" required>
    </div>
    <div>
      <label>Text to watch for (optional)</label>
      <input name="search_text" placeholder="e.g., 'Registration open' or 'Sold out'">
    </div>
    <div>
      <label>Frequency (minutes)</label>
      <input type="number" name="minutes" min="1" value="10" required>
    </div>
    <div>
      <label>Discord Webhook URL (optional)</label>
      <input type="url" name="webhook_url" placeholder="https://discord.com/api/webhooks/...">
      <div class="muted">Create one in Discord: Server Settings → Integrations → Webhooks.</div>
    </div>
    <div>
      <label>Notify at or below price (optional)</label>
      <input type="number" name="price_threshold" min="0" step="0.01" placeholder="e.g., 450">
      <div class="muted">Alert only when a detected C$ price ≤ this value. If blank, text match is used.</div>
    </div>

    <div>
      <button class="primary" type="submit">Create job</button>
    </div>
  </form>

  <div class="card">
    <h2>Jobs</h2>
    {% if jobs|length == 0 %}
      <p class="muted">No jobs yet — add one above.</p>
    {% else %}
      <table>
        <thead>
          <tr>
            <th class="drag">↕</th>
            <th>URL</th>
            <th>Search text</th>
            <th>Price ≤</th>
            <th>Lowest</th>
            <th>Every</th>
            <th>Created</th>
            <th>Artifacts</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="jobs-tbody">
          {% for j in jobs %}
          <tr data-id="{{ j.id }}">
            <td class="drag"><span class="drag-handle" draggable="true" title="Drag to reorder">⋮⋮</span></td>
            <td class="mono">{{ j.url }}</td>
            <td class="mono">{{ j.search_text }}</td>
            <td>{{ j.price_threshold or '—' }}</td>
            <td>{{ '%.2f'|format(j.lowest_price) if j.lowest_price is not none else '—' }}</td>
            <td>{{ j.minutes }} min</td>
            <td class="muted">{{ j.created_at }}</td>
            <td>
              <a href="/jobs/{{ j.id }}/files" target="_blank">files</a><br>
              <a href="/data/{{ j.id }}/latest.png" target="_blank">latest.png</a><br>
              <a href="/jobs/{{ j.id }}/latest" class="latest-txt">latest.txt</a>
            </td>
            <td class="row-actions">
              <a href="/jobs/{{ j.id }}/edit"><button type="button">Edit</button></a>
              <button class="run-now" type="button" data-id="{{ j.id }}">Run now</button>
              <form method="post" action="/jobs/{{ j.id }}/delete" onsubmit="return confirm('Delete this job?');"><button type="submit">Delete</button></form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <div class="card">
    <h3>Notes</h3>
    <ul>
      <li>Artifacts (screenshots & OCR text) are saved under <span class="mono">/data/&lt;job_id&gt;/</span> and served at <span class="mono">/data</span>.</li>
      <li><span class="mono">latest.png</span> and <span class="mono">latest.txt</span> are refreshed on each run for quick access.</li>
      <li>Drag the handle (⋮⋮) to reorder jobs; order is saved automatically.</li>
    </ul>
  </div>

  <div id="toast"></div>

  <script>
    const tbody = document.getElementById('jobs-tbody');
    const toastEl = document.getElementById('toast');
    let dragRow = null;

    function toast(msg, isError=false) {
      toastEl.textContent = msg;
      toastEl.style.background = isError ? '#b00020' : '#111';
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 1600);
    }

    // ---- Drag & drop ordering ----
    tbody.addEventListener('dragstart', (e) => {
      const handle = e.target.closest('.drag-handle');
      if (!handle) { e.preventDefault(); return; }
      dragRow = handle.closest('tr');
      dragRow.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', dragRow.dataset.id);
    });

    tbody.addEventListener('dragover', (e) => {
      e.preventDefault();
      const targetRow = e.target.closest('tr');
      if (!dragRow || !targetRow || targetRow === dragRow) return;
      const rect = targetRow.getBoundingClientRect();
      const offset = e.clientY - rect.top;
      const midpoint = rect.height / 2;
      if (offset > midpoint) {
        targetRow.after(dragRow);
      } else {
        targetRow.before(dragRow);
      }
    });

    function saveOrder() {
      const ids = Array.from(tbody.querySelectorAll('tr')).map(tr => tr.dataset.id);
      fetch('/jobs/reorder', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ order: ids })
      }).then(r => {
        if (r.ok) toast('Order saved');
        else toast('Failed to save order', true);
      }).catch(() => toast('Failed to save order', true));
    }

    tbody.addEventListener('drop', (e) => {
      e.preventDefault();
      if (dragRow) {
        dragRow.classList.remove('dragging');
        dragRow = null;
        saveOrder();
      }
    });

    tbody.addEventListener('dragend', () => {
      if (dragRow) {
        dragRow.classList.remove('dragging');
        dragRow = null;
      }
    });

    // ---- Run now (AJAX) ----
    tbody.addEventListener('click', (e) => {
      const btn = e.target.closest('.run-now');
      if (!btn) return;

      const jobId = btn.dataset.id;
      btn.disabled = true;
      const prevText = btn.textContent;
      btn.textContent = 'Running…';

      fetch(`/jobs/${jobId}/run-now`, { method: 'POST' })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(() => { toast('Job started'); })
        .catch(() => { toast('Failed to start job', true); })
        .finally(() => {
          btn.disabled = false;
          btn.textContent = prevText;
        });
    });

    // ---- latest.txt popup ----
    tbody.addEventListener('click', (e) => {
      const link = e.target.closest('.latest-txt');
      if (!link) return;
      e.preventDefault();
      const win = window.open('', '', 'width=600,height=400');
      fetch(link.href)
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(text => {
          const esc = text.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
          win.document.write(`<pre style="white-space: pre-wrap;">${esc}</pre>`);
          win.document.close();
        })
        .catch(() => {
          win.close();
          toast('Failed to load latest.txt', true);
        });
    });
  </script>
</body>
</html>
